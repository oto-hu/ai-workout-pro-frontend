name: Claude Next.js Auto Test & Fix

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-test:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        id: typecheck
        run: |
          echo "ğŸ”¬ TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          if npm run type-check 2>&1 | tee typecheck-output.log; then
            echo "âœ… å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            echo "typecheck_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ å‹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
            echo "typecheck_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run ESLint
        id: lint
        run: |
          echo "ğŸ” ESLintå®Ÿè¡Œä¸­..."
          if npm run lint 2>&1 | tee lint-output.log; then
            echo "âœ… ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°æˆåŠŸ"
            echo "lint_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°å¤±æ•—"
            echo "lint_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run tests
        id: test
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          if npm test -- --passWithNoTests --watchAll=false 2>&1 | tee test-output.log; then
            echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
            echo "test_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—"
            echo "test_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Build application
        id: build
        run: |
          echo "ğŸ—ï¸ Next.jsãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
          if npm run build 2>&1 | tee build-output.log; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ"
            echo "build_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—"
            echo "build_status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Collect detailed error information
        if: |
          steps.typecheck.outputs.typecheck_status == 'failed' ||
          steps.lint.outputs.lint_status == 'failed' ||
          steps.test.outputs.test_status == 'failed' ||
          steps.build.outputs.build_status == 'failed'
        run: |
          echo "## ğŸ” è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±" > error-details.md
          echo "" >> error-details.md
          
          if [ "${{ steps.typecheck.outputs.typecheck_status }}" = "failed" ]; then
            echo "### âŒ TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼" >> error-details.md
            echo "\`\`\`" >> error-details.md
            cat typecheck-output.log 2>/dev/null || echo "å‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—" >> error-details.md
            echo "\`\`\`" >> error-details.md
            echo "" >> error-details.md
          fi
          
          if [ "${{ steps.lint.outputs.lint_status }}" = "failed" ]; then
            echo "### âŒ ESLintã‚¨ãƒ©ãƒ¼" >> error-details.md
            echo "\`\`\`" >> error-details.md
            cat lint-output.log 2>/dev/null || echo "ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—" >> error-details.md
            echo "\`\`\`" >> error-details.md
            echo "" >> error-details.md
          fi
          
          if [ "${{ steps.test.outputs.test_status }}" = "failed" ]; then
            echo "### âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼" >> error-details.md
            echo "\`\`\`" >> error-details.md
            cat test-output.log 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—" >> error-details.md
            echo "\`\`\`" >> error-details.md
            echo "" >> error-details.md
          fi
          
          if [ "${{ steps.build.outputs.build_status }}" = "failed" ]; then
            echo "### âŒ Next.jsãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼" >> error-details.md
            echo "\`\`\`" >> error-details.md
            cat build-output.log 2>/dev/null || echo "ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—" >> error-details.md
            echo "\`\`\`" >> error-details.md
            echo "" >> error-details.md
          fi
          
          echo "## ğŸ“‹ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®" >> error-details.md
          [ "${{ steps.typecheck.outputs.typecheck_status }}" = "failed" ] && echo "- [ ] TypeScriptå‹ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£" >> error-details.md
          [ "${{ steps.lint.outputs.lint_status }}" = "failed" ] && echo "- [ ] ESLintã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£" >> error-details.md
          [ "${{ steps.test.outputs.test_status }}" = "failed" ] && echo "- [ ] ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ä¿®æ­£" >> error-details.md
          [ "${{ steps.build.outputs.build_status }}" = "failed" ] && echo "- [ ] ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£" >> error-details.md

      - name: Comment success results
        if: |
          github.event_name == 'pull_request' &&
          steps.typecheck.outputs.typecheck_status == 'passed' &&
          steps.lint.outputs.lint_status == 'passed' &&
          steps.test.outputs.test_status == 'passed' &&
          steps.build.outputs.build_status == 'passed'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `
            # ğŸ¤– Claude Next.jsè‡ªå‹•ãƒ†ã‚¹ãƒˆçµæœ
            
            ## ğŸ“‹ çµæœã‚µãƒãƒªãƒ¼
            - **TypeScriptå‹ãƒã‚§ãƒƒã‚¯**: âœ… æˆåŠŸ
            - **ESLint**: âœ… æˆåŠŸ
            - **ãƒ†ã‚¹ãƒˆ**: âœ… æˆåŠŸ  
            - **Next.jsãƒ“ãƒ«ãƒ‰**: âœ… æˆåŠŸ
            
            ## ğŸ¯ ç·åˆåˆ¤å®š
            âœ… **å…¨ãƒ†ã‚¹ãƒˆé€šé - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½**
            
            ã™ã¹ã¦ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã“ã®PRã¯äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚
            
            ---
            ğŸ’¡ [è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Auto-request fix from Claude on failure
        if: |
          github.event_name == 'pull_request' && (
            steps.typecheck.outputs.typecheck_status == 'failed' ||
            steps.lint.outputs.lint_status == 'failed' ||
            steps.test.outputs.test_status == 'failed' ||
            steps.build.outputs.build_status == 'failed'
          )
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorDetails = '';
            
            try {
              errorDetails = fs.readFileSync('error-details.md', 'utf8');
            } catch (e) {
              errorDetails = 'ã‚¨ãƒ©ãƒ¼è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
            }
            
            const typecheckStatus = '${{ steps.typecheck.outputs.typecheck_status }}';
            const lintStatus = '${{ steps.lint.outputs.lint_status }}';
            const testStatus = '${{ steps.test.outputs.test_status }}';
            const buildStatus = '${{ steps.build.outputs.build_status }}';
            
            const failureReport = `
            # ğŸš¨ Next.jsè‡ªå‹•ãƒ†ã‚¹ãƒˆå¤±æ•— - ä¿®æ­£ãŒå¿…è¦ã§ã™
            
            @claude Next.jsè‡ªå‹•ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š
            
            ## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ
            - **TypeScriptå‹ãƒã‚§ãƒƒã‚¯**: ${typecheckStatus === 'passed' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            - **ESLint**: ${lintStatus === 'passed' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            - **ãƒ†ã‚¹ãƒˆ**: ${testStatus === 'passed' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            - **Next.jsãƒ“ãƒ«ãƒ‰**: ${buildStatus === 'passed' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            
            ${errorDetails}
            
            ## ğŸ”§ å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™
            ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æã—ã¦ã€é©åˆ‡ãªä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ä¿®æ­£å¾Œã¯è‡ªå‹•çš„ã«å†ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            
            ## ğŸ“ Next.js/Reactä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ
            - TypeScriptã‚¨ãƒ©ãƒ¼: å‹å®šç¾©ã®ä¿®æ­£ã€interfaceã®è¿½åŠ 
            - ESLintã‚¨ãƒ©ãƒ¼: ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®ä¿®æ­£ã€æœªä½¿ç”¨å¤‰æ•°ã®å‰Šé™¤
            - ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¾ãŸã¯å®Ÿè£…ã®ä¿®æ­£
            - ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼: ä¾å­˜é–¢ä¿‚ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
            
            ---
            ğŸ’¡ [è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: failureReport
            });
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['ğŸš¨ nextjs-test-failed', 'ğŸ”§ needs-claude-fix']
              });
            } catch (e) {
              console.log('ãƒ©ãƒ™ãƒ«è¿½åŠ ã«å¤±æ•—');
            }

      - name: Set success labels
        if: |
          github.event_name == 'pull_request' &&
          steps.typecheck.outputs.typecheck_status == 'passed' &&
          steps.lint.outputs.lint_status == 'passed' &&
          steps.test.outputs.test_status == 'passed' &&
          steps.build.outputs.build_status == 'passed'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['âœ… nextjs-tests-passed', 'ğŸ‘€ ready-for-review']
              });
              
              const labelsToRemove = ['ğŸš¨ nextjs-test-failed', 'ğŸ”§ needs-claude-fix'];
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label
                  });
                } catch (e) {
                  // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
                }
              }
            } catch (e) {
              console.log('ãƒ©ãƒ™ãƒ«æ“ä½œã«å¤±æ•—');
            }
